name: Update GitHub release download badge

on:
  schedule:
    - cron: "0 0 * * *" # daily at 00:00 UTC
  workflow_dispatch: {}

jobs:
  update-release-downloads:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create meta directory
        run: mkdir -p meta

      - name: Calculate total and weekly release asset downloads
        id: calc
        env:
          OWNER: conduit-design
          REPO: conduit_design
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Fetch all releases and sum asset download_count using gh CLI (handles pagination)
          total=$(gh api repos/${OWNER}/${REPO}/releases --paginate \
            --jq 'map(.assets // [] | map(.download_count // 0) | add) | add // 0')

          echo "Total downloads (all time): ${total}"

          # Write Shields.io endpoint JSON for total downloads
          cat > meta/github-release-downloads.json <<EOF
          {
            "schemaVersion": 1,
            "label": "downloads",
            "message": "${total}",
            "color": "blue"
          }
          EOF

          # Maintain history of daily totals
          history_file="meta/github-release-downloads-history.json"
          today=$(date -u +%F)

          if [ -f "${history_file}" ]; then
            history=$(cat "${history_file}")
          else
            history="[]"
          fi

          # Upsert today's entry and sort by date
          updated_history=$(jq --arg date "${today}" --argjson total "${total}" '
            map(select(.date != $date)) + [{ "date": $date, "total": $total }] |
            sort_by(.date)
          ' <<< "${history}")

          printf '%s\n' "${updated_history}" > "${history_file}"

          # Compute downloads over the last 7 days (or since first record if < 7 days)
          weekly=$(jq '
            to_entries as $e
            | ($e | length) as $len
            | if $len == 0 then 0 else
                ($e[$len-1].value.total) as $latest |
                (if $len > 7 then $e[$len-1-7].value.total else $e[0].value.total end) as $base |
                ($latest - $base)
              end
          ' "${history_file}")

          echo "Downloads last 7 days (approx): ${weekly}"

          # Write Shields.io endpoint JSON for weekly downloads
          cat > meta/github-release-downloads-weekly.json <<EOF
          {
            "schemaVersion": 1,
            "label": "downloads (7d)",
            "message": "${weekly}",
            "color": "blue"
          }
          EOF

      - name: Commit and push if changed
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add meta/github-release-downloads.json meta/github-release-downloads-history.json meta/github-release-downloads-weekly.json
          git commit -m "chore: update GitHub release downloads badge" || exit 0
          git push
