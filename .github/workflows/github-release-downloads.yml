name: Update GitHub release download badge

on:
  schedule:
    - cron: "0 */4 * * *" # every 4 hours at minute 0 UTC
  workflow_dispatch: {}

jobs:
  update-release-downloads:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create meta directory
        run: mkdir -p meta

      - name: Calculate total and weekly release asset downloads
        id: calc
        env:
          OWNER: conduit-design
          REPO: conduit_design
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # Fetch all releases and sum asset download_count using gh CLI (handles pagination)
          total=$(gh api repos/${OWNER}/${REPO}/releases --paginate \
            --jq 'map(.assets // [] | map(.download_count // 0) | add) | add // 0')

          echo "Total downloads (all time): ${total}"

          # Write Shields.io endpoint JSON for total downloads
          cat > meta/github-release-downloads.json <<EOF
          {
            "schemaVersion": 1,
            "label": "Total downloads",
            "message": "${total}",
            "color": "#a855f7"
          }
          EOF

          # Maintain history of daily totals
          history_file="meta/github-release-downloads-history.json"
          today=$(date -u +%F)

          if [ -f "${history_file}" ]; then
            history=$(cat "${history_file}")
          else
            history="[]"
          fi

          # Upsert today's entry and sort by date
          updated_history=$(jq --arg date "${today}" --argjson total "${total}" '
            map(select(.date != $date)) + [{ "date": $date, "total": $total }] |
            sort_by(.date)
          ' <<< "${history}")

          printf '%s\n' "${updated_history}" > "${history_file}"

          # Compute downloads over the last 7 days (inclusive), by summing daily deltas
          weekly=$(jq '
            map(.total) as $t
            | ($t | length) as $len
            | if $len == 0 then 0 else
                # Per-day downloads = diff between consecutive totals (first day = first total)
                [ range(0; $len)
                  | if . == 0 then $t[0] else ($t[.] - $t[.-1]) end
                ] as $deltas
                | ($deltas | length) as $dlen
                # Take the last up-to-7 days and sum them
                | ($deltas
                    | if $dlen <= 7 then . else .[($dlen-7):] end
                  )
                | add
              end
          ' "${history_file}")

          echo "Downloads last 7 days (approx): ${weekly}"

          # Write Shields.io endpoint JSON for weekly downloads
          cat > meta/github-release-downloads-weekly.json <<EOF
          {
            "schemaVersion": 1,
            "label": "Downloads (7d)",
            "message": "${weekly}",
            "color": "#a855f7"
          }
          EOF

          # Compute downloads over the last 30 days (inclusive), by summing daily deltas
          thirty=$(jq '
            map(.total) as $t
            | ($t | length) as $len
            | if $len == 0 then 0 else
                [ range(0; $len)
                  | if . == 0 then $t[0] else ($t[.] - $t[.-1]) end
                ] as $deltas
                | ($deltas | length) as $dlen
                | ($deltas
                    | if $dlen <= 30 then . else .[($dlen-30):] end
                  )
                | add
              end
          ' "${history_file}")

          echo "Downloads last 30 days (approx): ${thirty}"

          # Write Shields.io endpoint JSON for 30-day downloads
          cat > meta/github-release-downloads-30d.json <<EOF
          {
            "schemaVersion": 1,
            "label": "Downloads (30d)",
            "message": "${thirty}",
            "color": "#a855f7"
          }
          EOF

      - name: Commit and push if changed
        run: |
          set -euo pipefail

          # Stage files first so we also detect newly created files
          git add meta/github-release-downloads.json meta/github-release-downloads-history.json meta/github-release-downloads-weekly.json meta/github-release-downloads-30d.json

          # If there are no staged changes, exit early
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -m "chore: update GitHub release downloads badge" || exit 0
          git push
